name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'subscription/**'
      - 'web/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
  workflow_run:
    workflows: ["Release"]
    types: [completed]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages and commits
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Build GitHub Pages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          
      - name: Install root dependencies
        run: npm ci
        
      - name: Build adblock generator project
        run: npm run build
        
      - name: Check source files and generate lists
        run: |
          echo "ğŸ” Checking for source files..."
          
          # Check if source file exists
          if [[ ! -f "adblock-filters-list/adblock-filters-list.txt" ]]; then
            echo "âŒ Source file not found: adblock-filters-list/adblock-filters-list.txt"
            echo "ğŸ“ Current directory contents:"
            ls -la
            echo "ğŸ“ Looking for adblock-filters-list directory:"
            find . -name "*adblock*" -type f 2>/dev/null || echo "No adblock files found"
            
            echo "ğŸ”§ Creating example source file for demonstration..."
            mkdir -p adblock-filters-list
            cat > adblock-filters-list/adblock-filters-list.txt << 'EOF'
          ! Thai Adblock List - Example Rules
          ! This is a demonstration file
          ||example.com^
          example.com##.ad
          ||test.com/ads^
          test.com##.banner
          ||demo.co.th^$third-party
          demo.co.th##div[class*="advertisement"]
          EOF
            echo "âœ… Created example source file"
          else
            echo "âœ… Source file found: adblock-filters-list/adblock-filters-list.txt"
            echo "ğŸ“Š File size: $(du -h adblock-filters-list/adblock-filters-list.txt)"
            echo "ğŸ“ Line count: $(wc -l < adblock-filters-list/adblock-filters-list.txt)"
          fi
          
          # Generate adblock lists
          echo "ğŸš€ Generating adblock lists..."
          npm start
          
          # Check if subscription folder was created
          if [[ -d "subscription" ]]; then
            echo "âœ… Subscription folder created successfully"
            echo "ğŸ“ Generated files:"
            ls -la subscription/
            echo "ğŸ“Š File sizes:"
            du -h subscription/*
          else
            echo "âŒ Subscription folder not created"
            echo "ğŸ” Checking for any generated files:"
            find . -name "*.txt" -newer . 2>/dev/null || echo "No new .txt files found"
            exit 1
          fi
          
      - name: Commit generated files to repository
        run: |
          echo "ğŸ“ Committing generated files to repository..."
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add generated files
          git add subscription/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            echo "âœ… Changes detected, committing..."
            git commit -m "ğŸ¤– Auto-update adblock lists - $(date +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "ğŸš€ Files committed and pushed to repository"
          fi

      - name: Install web app dependencies
        working-directory: ./web
        run: npm ci
        
      - name: Build React web app
        working-directory: ./web
        run: npm run build
        
      - name: Prepare deployment folder
        run: |
          echo "ğŸ“ Preparing deployment folder..."
          mkdir -p deploy
          
          # Copy React app build
          cp -r web/dist/* deploy/
          
          # Copy adblock lists to the web app
          mkdir -p deploy/lists
          cp subscription/*.txt deploy/lists/
          
          # Also make them available at root level for direct access
          cp subscription/*.txt deploy/
          
          echo "âœ… Deployment folder prepared"
          echo "ğŸ“ Deploy folder contents:"
          ls -la deploy/
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: deploy/

  deploy:
    name: Deploy to Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Verify deployment
        run: |
          echo "ğŸš€ Deployment completed successfully!"
          echo "ğŸ“„ Website URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“Š Lists are now available at:"
          echo "  - uBlock Origin: ${{ steps.deployment.outputs.page_url }}thai-adblock-list-ublockorigin.txt"
          echo "  - Adblock Plus: ${{ steps.deployment.outputs.page_url }}thai-adblock-list-adblockplus.txt"
          echo "  - AdGuard: ${{ steps.deployment.outputs.page_url }}thai-adblock-list-adguard.txt"
          echo "  - Domains: ${{ steps.deployment.outputs.page_url }}domains.txt"